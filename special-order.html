<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>طلب العرض الخاص</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: sans-serif;
      padding: 20px;
      font-size: 18px;
      line-height: 1.6;
    }

    .box {
      background: #222;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }

    label {
      display: block;
      margin-top: 10px;
    }

    input, select, textarea, button {
      padding: 12px;
      margin-top: 5px;
      width: 100%;
      border: none;
      border-radius: 6px;
      background-color: #e5c9a0;
      color: #000;
      font-size: 18px;
    }

    button {
      cursor: pointer;
      margin-top: 20px;
    }

    #region-group {
      display: none;
    }
  </style>
</head>
<body>

  <h2>🛍️ طلب العرض الخاص</h2>

  <div class="box">
    <p><strong>المنتج:</strong> <span id="product-name"></span></p>
    <p><strong>السعر:</strong> <span id="product-price"></span></p>
    <p><strong>الكمية:</strong> <span id="product-quantity"></span></p>
    <p><strong>نقاط الولاء:</strong> <span id="product-points"></span></p>
  </div>

  <form onsubmit="submitOrder(event)">
    <label>الاسم الكامل:</label>
    <input type="text" id="customer-name" required>

    <label>رقم واتساب إماراتي:</label>
    <input type="tel" id="customer-phone" placeholder="05..." required>

    <label>الإمارة:</label>
    <select id="emirate" onchange="showRegion()" required>
      <option value="">اختر الإمارة</option>
      <option value="دبي">دبي</option>
      <option value="أبوظبي">أبوظبي</option>
      <option value="الشارقة">الشارقة</option>
      <option value="عجمان">عجمان</option>
      <option value="رأس الخيمة">رأس الخيمة</option>
      <option value="أم القيوين">أم القيوين</option>
      <option value="الفجيرة">الفجيرة</option>
    </select>

    <div id="region-group">
      <label>المنطقة:</label>
      <input type="text" id="region" required>
    </div>

    <button type="submit">📨 تأكيد الطلب عبر واتساب</button>
  </form>

  <script>
    // قراءة بيانات العرض من الرابط
    const params = new URLSearchParams(window.location.search);
    const name = params.get("name") || "";
    const price = params.get("price") || "";
    const quantity = params.get("quantity") || "";
    const points = params.get("points") || "0";

    // تعبئة تفاصيل العرض
    document.getElementById("product-name").textContent = name;
    document.getElementById("product-price").textContent = price + " درهم";
    document.getElementById("product-quantity").textContent = quantity + " كروز";
    document.getElementById("product-points").textContent = points + " نقطة";

    // إظهار حقل المنطقة عند اختيار الإمارة
    function showRegion() {
      const emirate = document.getElementById("emirate").value;
      document.getElementById("region-group").style.display = emirate ? "block" : "none";
    }

    // إرسال الطلب إلى واتساب وحفظ النقاط
    function submitOrder(e) {
  e.preventDefault();

  const customerName = document.getElementById("customer-name").value.trim();
  const phone = document.getElementById("customer-phone").value.trim();
  const emirate = document.getElementById("emirate").value;
  const region = document.getElementById("region").value.trim();

  if (!phone.startsWith("05")) {
    alert("يرجى إدخال رقم إماراتي يبدأ بـ 05");
    return;
  }

  const query = new URLSearchParams({
    name: customerName,
    phone: phone,
    points: points,
    source: `عرض خاص: ${name}`
  }).toString();

  fetch(`https://script.google.com/macros/s/AKfycby62ahFxkL0N4GYhEJZzuOC7Yk-3XdKYqi6KanLqyhj4uOjDzYZecaJx4UAF4tT6Cs93A/exec?${query}`)
    .then(res => res.text())
    .then(txt => {
      document.getElementById("save-status").textContent = "📌 رد السكربت: " + txt;

      // بعد نجاح الحفظ، افتح واتساب
      let message = `🛍️ طلب عرض خاص\n`;
      message += `👤 الاسم: ${customerName}\n`;
      message += `📱 الرقم: ${phone}\n`;
      message += `🏙️ الإمارة: ${emirate}\n`;
      message += `📍 المنطقة: ${region}\n`;
      message += `\n📦 المنتج: ${name}\n`;
      message += `📦 الكمية: ${quantity} كروز\n`;
      message += `💰 السعر: ${price} درهم\n`;
      message += `🎯 نقاط الولاء المكتسبة: ${points}\n`;

      const encoded = encodeURIComponent(message);
      const myNumber = "963960048355";
      window.open(`https://wa.me/${myNumber}?text=${encoded}`, "_blank");
    })
    .catch(err => {
      document.getElementById("save-status").textContent = "❌ خطأ بالحفظ: " + err.message;
    });
}
  </script>

</body>
</html>
